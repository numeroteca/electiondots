<!DOCTYPE html>
<!-- via http://bl.ocks.org/tomgp/6fb9b8c93f86b24d6828 -->
<html>
<head>
	<title>Elecciones 20D. </title>
	<script src="http://d3js.org/d3.v4.0.0-alpha.18.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="d3-iconarray.js"></script>
	<style type="text/css">
	*{
		font-family: sans-serif;
		color: #333;
	}
	div.tooltip {   
		position: absolute;             
		width: 160px;                         
		padding: 8px;             
		font: 12px sans-serif;        
		background: #ddd;   
		border: 0px;      
		border-radius: 4px;           
		pointer-events: none;         
	}
	</style>
</head>
<body>
<h1>Elecciones 20D</h1>
<p>C&oacute;digo a partir de <a href="http://bl.ocks.org/tomgp/6fb9b8c93f86b24d6828">Tom Pearson</a></p>
<p>Cada punto representa a 10.000 habitantes</p>
<div id="gbs-example">

</div>
</body>
<script type="text/javascript">

var data = [
 {
   "label":"Abstenciones",
   "count":928,
   "colour":"#dddddd"
 },
 {
   "label":"PP",
   "count":721,
   "colour":"#397da0"
 },
 {
   "label":"PSOE",
   "count":553,
   "colour":"#cc2630"
 },
 {
   "label":"Podemos",
   "count":519,
   "colour":"#896897"
 },
 {
   "label":"Ciudadanos",
   "count":350,
   "colour":"#fcbb5c"
 },
 {
   "label":"DL",
   "count":57,
   "colour":"#002369"
 },
 {
   "label":"ERC",
   "count":60,
   "colour":"#ffa31d"
 },
 {
   "label":"PNV",
   "count":30,
   "colour":"#7aae30"
 },
 {
   "label":"IU",
   "count":92,
   "colour":"#037b51"
 },
 {
   "label":"Bildu",
   "count":21,
   "colour":"#666"
 },
 {
   "label":"CC",
   "count":8,
   "colour":"#666"
 },
 {
   "label":"Animalista",
   "count":21,
   "colour":"#666"
 },
 {
   "label":"UPyD",
   "count":15,
   "colour":"#666"
 },
 {
   "label":"BNG",
   "count":7,
   "colour":"#666"
 },
 {
   "label":"Unio",
   "count":6,
   "colour":"#666"
 },
 {
   "label":"Vox",
   "count":6,
   "colour":"#666"
 },
 {
   "label":"Otros",
   "count":22,
   "colour":"#666"
 }
];

var layout = d3_iconarray.layout()
	.width(70) //number of dots per line
	.height(35);

//expand the data to an array
var dataArray = data.reduce(function(value, d){
	    for(var i=0;i<d.count ;i++){
	        value.push(d.colour);
	    }
	    return value;
	}, []);

var grid = layout(dataArray);

var dotRadius = 5;
var width = 1200, 
	height = 1200, 
	margin = {top:20, bottom:20, left:20, right:300 };

var arrayScale = d3.scaleLinear()
	.domain([ 0, 70 ]) //numer of gaps in every row
	.range([0, width-(margin.left+margin.right)]);
var svg = d3.select('#gbs-example')
		.append('svg')
			.attr('width',width)
			.attr('height',height)
		.append('g')
			.attr('transform','translate('+margin.left+','+margin.top+')');
var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
		.style("opacity", 0);

svg.selectAll('circle')
	.data(grid)
		.enter()
	.append('circle')
		.attr('cx', function(d){ 
			return arrayScale(d.position.x); 
		})
		.attr('cy', function(d){ 
			return arrayScale(d.position.y); 
		})
		.attr('r',dotRadius)
		.attr('fill',function(d){ return d.data; })
		.on("mouseover", function(d) {      
			div.transition()
				.duration(200)      
				.style("opacity", .9);      
			div.html("10.000 personas")  
				.style("left", (d3.event.pageX) + "px")     
				.style("top", (d3.event.pageY) - 60 + "px");    
					})                  
			.on("mouseout", function(d) {       
					div.transition()        
				.duration(500)      
				.style("opacity", 0);   
			});


//Legend?
d3.select('#gbs-example svg')
	.append('g').attr('transform','translate('+ (width-margin.right + 50)+',' + (margin.top + dotRadius) + ')')
	.selectAll('g.key-element')
	.data(data)
		.enter()
	.append('g')
		.attr('transform',function(d,i){ return 'translate(0,'+(i*20)+')'; })
		.attr('class','key-element')
	.call(function(parent){
		parent.append('circle')
			.attr('r', dotRadius)
			.attr('cx', -dotRadius*2)
			.attr('cy', -dotRadius)	
			.attr('fill', function(d){ return d.colour; })
		
		parent.append('text')
			.attr('dx', 0)
			.attr('dy',0 )
			.text(function(d){
				return d.label + ' (' + d.count + ' x 10M hab)';
			})
			.call(wrap, margin.right-10);
	})


//wrapping long labels https://bl.ocks.org/mbostock/7555321

function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}

d3.select(self.frameElement).style("height", (height + 200)+"px");

</script>
<p>Datos <a href="http://resultadosgenerales2015.interior.es/congreso/#/ES201512-CON-ES/ES">resultadosgenerales2015.interior.es</a>
</html>
